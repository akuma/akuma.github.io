<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Java 转换透明背景图片为 JPEG 的问题 · Coding Life</title><meta name="description" content="Java 转换透明背景图片为 JPEG 的问题 - Akuma Huang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://akuma.github.io/atom.xml" title="Coding Life"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/akuma" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Java 转换透明背景图片为 JPEG 的问题</h1><div class="post-info">Dec 10, 2016</div><div class="post-content"><p>最近遇到一个 Java 转换透明背景图片为 JPEG 图片后背景变黑的问题。</p>
<p>具体情况是这样的，我们有个产品的安卓端将某个 WebView 截图后上传给服务端，服务端为了节省存储空间和带宽，会对图片进行缩放处理。而某些安卓机型上传的 JPEG 图片被服务端处理后变成了黑色。我用图像处理工具查看这些图片，发现它们其实只是背景变黑了。</p>
<a id="more"></a>
<h2 id="问题原因分析"><a href="#问题原因分析" class="headerlink" title="问题原因分析"></a>问题原因分析</h2><p>通过分析安卓端和服务端的相关代码以及 Google 搜索相关资料，我终于发现了问题所在。</p>
<p>首先简单说一下 PNG 和 JPEG 的一些区别。JPEG 是一种有损压缩的图片格式，以 24 位颜色存储单个位图，不支持动画、不支持透明色。PNG 是一种无损压缩的图片格式，有 8 位、24 位、32 位三种形式，其中 8 位 PNG 支持两种不同的透明形式（索引透明和 Alpha 透明），24 位 PNG 不支持透明，32 位 PNG 在 24 位基础上增加了 8 位透明通道。</p>
<p>我们安卓端的截图是 32 位的 PNG 图片，但命名时的后缀名却是 <code>.jpg</code>。经过测试，有些安卓机型所截图片的背景色是白色的，有些则是透明的。我们的服务端接受到图片后，会根据图片的后缀名进行处理，目的是保持原有的格式。在这种情况下，对于背景透明的 PNG 图片，因为被服务端当做 JPEG 处理，所以 32 位色彩被强制转换成了 24 位色彩，背景就变黑了。</p>
<h2 id="问题解决办法"><a href="#问题解决办法" class="headerlink" title="问题解决办法"></a>问题解决办法</h2><p>知道了问题产生的原因后就好办了。我最后的解决办法是修改了服务端的图片处理代码，在处理原图片时判断图片的背景是否透明，如果背景透明而目标文件又是 JPEG 格式，则通过处理丢弃原图片中的 Alpha 通道。具体的实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 如果目标图片是 JPEG 图片并且图像是透明的，就丢弃 Alpha 通道，否则会导致转换出来的 JPEG 图片背景黑色。</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BufferedImage <span class="title">discardAlphaChannelForJpeg</span><span class="params">(BufferedImage image, String fileType)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isJpegImage(fileType) &amp;&amp; image.getTransparency() == Transparency.TRANSLUCENT) &#123;</div><div class="line">        image = get24BitImage(image);                 <span class="comment">// 第一种方式</span></div><div class="line">        <span class="comment">// image = get24BitImage(image, Color.BLACK); // 第二种方式，可以指定背景色</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> image;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 根据文件后缀名判断是否是 JPEG 图片。</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isJpegImage</span><span class="params">(String fileType)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"jpg"</span>.equalsIgnoreCase(fileType) || <span class="string">"jpeg"</span>.equalsIgnoreCase(fileType);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 使用删除 Alpha 值的方式去掉图像的 Alpha 通道。</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BufferedImage <span class="title">get24BitImage</span><span class="params">(BufferedImage image)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> w = image.getWidth();</div><div class="line">    <span class="keyword">int</span> h = image.getHeight();</div><div class="line">    <span class="keyword">int</span>[] argb = getRGBs(image.getRGB(<span class="number">0</span>, <span class="number">0</span>, w, h, <span class="keyword">null</span>, <span class="number">0</span>, w));</div><div class="line">    BufferedImage newImage = <span class="keyword">new</span> BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);</div><div class="line">    newImage.setRGB(<span class="number">0</span>, <span class="number">0</span>, w, h, argb, <span class="number">0</span>, w);</div><div class="line">    <span class="keyword">return</span> newImage;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 使用绘制的方式去掉图像的 Alpha 值。</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BufferedImage <span class="title">get24BitImage</span><span class="params">(BufferedImage image, Color bgColor)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> w = image.getWidth();</div><div class="line">    <span class="keyword">int</span> h = image.getHeight();</div><div class="line">    BufferedImage newImage = <span class="keyword">new</span> BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);</div><div class="line">    Graphics2D graphic = newImage.createGraphics();</div><div class="line">    graphic.setColor(bgColor);</div><div class="line">    graphic.fillRect(<span class="number">0</span>, <span class="number">0</span>, w, h);</div><div class="line">    graphic.drawRenderedImage(image, <span class="keyword">null</span>);</div><div class="line">    graphic.dispose();</div><div class="line">    <span class="keyword">return</span> newImage;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 将 32 位色彩转换成 24 位色彩（丢弃 Alpha 通道）。</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] getRGBs(<span class="keyword">int</span>[] argbs) &#123;</div><div class="line">    <span class="keyword">int</span>[] rgbs = <span class="keyword">new</span> <span class="keyword">int</span>[argbs.length];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argbs.length; i++) &#123;</div><div class="line">        rgbs[i] = argbs[i] &amp; <span class="number">0xffffff</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> rgbs;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2017/01/05/macOS-开发环境搭建笔记/" class="prev">上一篇</a><a href="/2016/12/03/阿里云-ECS-搭建正向代理/" class="next">下一篇</a></div><div data-thread-key="2016/12/10/Java-转换透明背景图片为-JPEG-的问题/" data-title="Java 转换透明背景图片为 JPEG 的问题" data-url="https://akuma.github.io/2016/12/10/Java-转换透明背景图片为-JPEG-的问题/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"iakuma"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2009 - 2017 <a href="https://akuma.github.io">Akuma Huang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>