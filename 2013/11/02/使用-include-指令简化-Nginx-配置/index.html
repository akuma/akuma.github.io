<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 include 指令简化 Nginx 配置 · Coding Life</title><meta name="description" content="使用 include 指令简化 Nginx 配置 - Akuma Huang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://akuma.github.io/atom.xml" title="Coding Life"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/akuma" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用 include 指令简化 Nginx 配置</h1><div class="post-info">Nov 2, 2013</div><div class="post-content"><p>在查看公司生产环境的 nginx 配置文件时，经常可以看到大段重复的代码，导致修改一个相同的配置，往往要同时修改好几个地方（比如使用了多个虚拟主机的情况），可维护性非常差。</p>
<a id="more"></a>
<p>上述问题其实可以很简单的通过 include 指令来简化配置文件，下面就通过一个配置文件的例子来说明如何简化配置。</p>
<h2 id="简化前的配置-conf-nginx-conf"><a href="#简化前的配置-conf-nginx-conf" class="headerlink" title="简化前的配置 conf/nginx.conf"></a>简化前的配置 conf/nginx.conf</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">user</span>              nobody nobody;</div><div class="line"><span class="attribute">worker_processes</span>  <span class="number">4</span>;</div><div class="line"></div><div class="line"><span class="attribute">pid</span>               logs/nginx.pid;</div><div class="line"><span class="attribute">error_log</span>         logs/error.log <span class="literal">error</span>;</div><div class="line"></div><div class="line"><span class="section">events</span> &#123;</div><div class="line">    <span class="attribute">use</span>                 <span class="literal">epoll</span>;</div><div class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="section">http</span> &#123;</div><div class="line">    <span class="attribute">include</span>           mime.types;</div><div class="line">    <span class="attribute">include</span>           proxy.conf;</div><div class="line"></div><div class="line">    <span class="attribute">sendfile</span>          <span class="literal">on</span>;</div><div class="line">    <span class="attribute">tcp_nopush</span>        <span class="literal">on</span>;</div><div class="line">    <span class="attribute">tcp_nodelay</span>       <span class="literal">off</span>;</div><div class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">0</span>;</div><div class="line">    <span class="attribute">default_type</span>      application/octet-stream;</div><div class="line"></div><div class="line">    <span class="attribute">upstream</span> backend &#123;</div><div class="line">        <span class="attribute">server</span>        <span class="number">192.168.1.188:8080</span> srun_id=c1 weight=<span class="number">1</span>;</div><div class="line">        <span class="attribute">jvm_route</span>     <span class="variable">$cookie_JSESSIONID</span> reverse;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="section">server</span> &#123;</div><div class="line">        <span class="attribute">listen</span>        <span class="number">80</span>;</div><div class="line">        <span class="attribute">server_name</span>   foo.com;</div><div class="line">        <span class="attribute">index</span>         index.html index.htm;</div><div class="line">        <span class="attribute">access_log</span>    logs/access.log;</div><div class="line"></div><div class="line">        <span class="attribute">location</span> / &#123;</div><div class="line">            <span class="attribute">proxy_pass</span> http://backend;</div><div class="line">            <span class="attribute">proxy_redirect</span>              <span class="literal">off</span>;</div><div class="line">            <span class="attribute">proxy_set_header</span>            Host            <span class="variable">$host</span>;</div><div class="line">            <span class="attribute">proxy_set_header</span>            X-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line">            <span class="attribute">proxy_set_header</span>            X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">            <span class="attribute">client_max_body_size</span>        <span class="number">50M</span>;</div><div class="line">            <span class="attribute">client_body_buffer_size</span>     <span class="number">256k</span>;</div><div class="line">            <span class="attribute">proxy_connect_timeout</span>       <span class="number">600</span>;</div><div class="line">            <span class="attribute">proxy_send_timeout</span>          <span class="number">300</span>;</div><div class="line">            <span class="attribute">proxy_read_timeout</span>          <span class="number">300</span>;</div><div class="line">            <span class="attribute">proxy_buffer_size</span>           <span class="number">4k</span>;</div><div class="line">            <span class="attribute">proxy_buffers</span>               <span class="number">4</span> <span class="number">32k</span>;</div><div class="line">            <span class="attribute">proxy_busy_buffers_size</span>     <span class="number">64k</span>;</div><div class="line">            <span class="attribute">proxy_temp_file_write_size</span>  <span class="number">64k</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="attribute">location</span> /status &#123;</div><div class="line">            <span class="attribute">stub_status</span>    <span class="literal">on</span>;</div><div class="line">            <span class="attribute">access_log</span>     <span class="literal">off</span>;</div><div class="line">            <span class="attribute">allow</span>          all;</div><div class="line">            <span class="attribute">deny</span>           all;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用-include-指令简化配置文件"><a href="#使用-include-指令简化配置文件" class="headerlink" title="使用 include 指令简化配置文件"></a>使用 include 指令简化配置文件</h2><h3 id="抽取-proxy-设置到单独文件中（conf-proxy-conf）"><a href="#抽取-proxy-设置到单独文件中（conf-proxy-conf）" class="headerlink" title="抽取 proxy 设置到单独文件中（conf/proxy.conf）"></a>抽取 proxy 设置到单独文件中（<code>conf/proxy.conf</code>）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">proxy_redirect</span>              <span class="literal">off</span>;</div><div class="line"><span class="attribute">proxy_set_header</span>            Host            <span class="variable">$host</span>;</div><div class="line"><span class="attribute">proxy_set_header</span>            X-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line"><span class="attribute">proxy_set_header</span>            X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line"><span class="attribute">client_max_body_size</span>        <span class="number">50M</span>;</div><div class="line"><span class="attribute">client_body_buffer_size</span>     <span class="number">256k</span>;</div><div class="line"><span class="attribute">proxy_connect_timeout</span>       <span class="number">600</span>;</div><div class="line"><span class="attribute">proxy_send_timeout</span>          <span class="number">300</span>;</div><div class="line"><span class="attribute">proxy_read_timeout</span>          <span class="number">300</span>;</div><div class="line"><span class="attribute">proxy_buffer_size</span>           <span class="number">4k</span>;</div><div class="line"><span class="attribute">proxy_buffers</span>               <span class="number">4</span> <span class="number">32k</span>;</div><div class="line"><span class="attribute">proxy_busy_buffers_size</span>     <span class="number">64k</span>;</div><div class="line"><span class="attribute">proxy_temp_file_write_size</span>  <span class="number">64k</span>;</div></pre></td></tr></table></figure>
<h3 id="抽取-status-设置到单独文件中（conf-status-conf）"><a href="#抽取-status-设置到单独文件中（conf-status-conf）" class="headerlink" title="抽取 status 设置到单独文件中（conf/status.conf）"></a>抽取 status 设置到单独文件中（<code>conf/status.conf</code>）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span> /status &#123;</div><div class="line">    <span class="attribute">stub_status</span>    <span class="literal">on</span>;</div><div class="line">    <span class="attribute">access_log</span>     <span class="literal">off</span>;</div><div class="line">    <span class="attribute">allow</span>          all;</div><div class="line">    <span class="attribute">deny</span>           all;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="抽取杂项配置到单独文件中（conf-misc-conf）"><a href="#抽取杂项配置到单独文件中（conf-misc-conf）" class="headerlink" title="抽取杂项配置到单独文件中（conf/misc.conf）"></a>抽取杂项配置到单独文件中（<code>conf/misc.conf</code>）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">sendfile</span>          <span class="literal">on</span>;</div><div class="line"><span class="attribute">tcp_nopush</span>        <span class="literal">on</span>;</div><div class="line"><span class="attribute">tcp_nodelay</span>       <span class="literal">off</span>;</div><div class="line"><span class="attribute">keepalive_timeout</span> <span class="number">0</span>;</div><div class="line"><span class="attribute">default_type</span>      application/octet-stream;</div></pre></td></tr></table></figure>
<h3 id="最终简化后的配置"><a href="#最终简化后的配置" class="headerlink" title="最终简化后的配置"></a>最终简化后的配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">user</span>              nobody nobody;</div><div class="line"><span class="attribute">worker_processes</span>  <span class="number">4</span>;</div><div class="line"></div><div class="line"><span class="attribute">pid</span>               logs/nginx.pid;</div><div class="line"><span class="attribute">error_log</span>         logs/error.log <span class="literal">error</span>;</div><div class="line"></div><div class="line"><span class="section">events</span> &#123;</div><div class="line">    <span class="attribute">use</span>                 <span class="literal">epoll</span>;</div><div class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="section">http</span> &#123;</div><div class="line">    <span class="attribute">include</span>   mime.types;</div><div class="line">    <span class="attribute">include</span>   proxy.conf;</div><div class="line">    <span class="attribute">incluee</span>   misc.conf;</div><div class="line"></div><div class="line">    <span class="attribute">upstream</span> backend &#123;</div><div class="line">        <span class="attribute">server</span>      <span class="number">192.168.1.188:8080</span> srun_id=c1 weight=<span class="number">1</span>;</div><div class="line">        <span class="attribute">jvm_route</span>   <span class="variable">$cookie_JSESSIONID</span> reverse;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="section">server</span> &#123;</div><div class="line">        <span class="attribute">listen</span>      <span class="number">80</span>;</div><div class="line">        <span class="attribute">server_name</span> foo.com;</div><div class="line">        <span class="attribute">charset</span>     utf-<span class="number">8</span>;</div><div class="line">        <span class="attribute">index</span>       index.html index.htm;</div><div class="line">        <span class="attribute">access_log</span>  logs/access.log;</div><div class="line"></div><div class="line">        <span class="attribute">location</span> / &#123;</div><div class="line">            <span class="attribute">proxy_pass</span> http://backend;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="attribute">include</span>     status.conf;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/10/10/evermark-介绍/" class="prev">上一篇</a><a href="/2013/07/07/几种-Linux-发行版的网络配置/" class="next">下一篇</a></div><div data-thread-key="2013/11/02/使用-include-指令简化-Nginx-配置/" data-title="使用 include 指令简化 Nginx 配置" data-url="https://akuma.github.io/2013/11/02/使用-include-指令简化-Nginx-配置/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"iakuma"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2009 - 2017 <a href="https://akuma.github.io">Akuma Huang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>