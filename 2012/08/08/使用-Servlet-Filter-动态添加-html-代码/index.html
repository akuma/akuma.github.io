<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 Servlet Filter 动态添加 html 代码 · Coding Life</title><meta name="description" content="使用 Servlet Filter 动态添加 html 代码 - Akuma Huang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://akuma.github.io/atom.xml" title="Coding Life"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/akuma" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用 Servlet Filter 动态添加 html 代码</h1><div class="post-info">Aug 8, 2012</div><div class="post-content"><p>最近一个同事问我，怎么快速实现在一个老系统的页面上统一添加用于页面性能分析的 JavaScript 脚本。确实，老系统这么多页面，如果一个一个去修改是非常费时而且笨的做法。</p>
<a id="more"></a>
<p>我想了一下，写了一个 Servlet Filter，可以实现在 HTTP 响应内容中的某个节点（比如 <code>&lt;/body&gt;</code> ）前添加 HTML 代码，优雅的解决了这个问题。</p>
<h2 id="使用样例"><a href="#使用样例" class="headerlink" title="使用样例"></a>使用样例</h2><h3 id="插入-html-代码的类"><a href="#插入-html-代码的类" class="headerlink" title="插入 html 代码的类"></a>插入 html 代码的类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> demo;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 继承 HtmlContentProvider，实现提供插入内容的方法。</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HtmlContentProviderImpl</span> <span class="keyword">implements</span> <span class="title">HtmlContentProvider</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"&lt;div style=\"display:none\"&gt;"</span></div><div class="line">                + <span class="string">"&lt;script src=\"http://s16.cnzz.com/stat.php?id=xxxxxxx&amp;web_id=xxxxxxx\""</span></div><div class="line">                + <span class="string">" language=\"javascript\"&gt;&lt;/script&gt;&lt;/div&gt;"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Spring-配置"><a href="#Spring-配置" class="headerlink" title="Spring 配置"></a>Spring 配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"htmlContentAppendFilter"</span> <span class="attr">class</span>=<span class="string">"demo.HtmlContentAppendFilter"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 插入代码的节点名称，本例是 &lt;/head&gt;，表示将代码添加到 &lt;/head&gt; 节点之前 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"htmlNode"</span> <span class="attr">value</span>=<span class="string">"&amp;lt;/head&amp;gt;"</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 在响应内容中查找节点时，是否采用反向查找的方式，本例采用正向查找 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"reverseLookup"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 定义需要进行过滤的 requestPath 的正则表达式，本例只过滤 .htm 后缀请求 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"includes"</span> <span class="attr">value</span>=<span class="string">".+\.htm"</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 定义需要忽略过滤的 requestPath 的正则表达式，本例排除对 ReplyAction 请求的过滤 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"excludes"</span> <span class="attr">value</span>=<span class="string">"/.+/remote.+"</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 提供 HTML 代码的实现类，该内容会被添加到指定节点之前 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"htmlContentProvider"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"demo.HtmlContentProviderImpl"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="web-xml-配置"><a href="#web-xml-配置" class="headerlink" title="web.xml 配置"></a>web.xml 配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>htmlContentAppendFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetBeanName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>htmlContentAppendFilter<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>htmlContentAppendFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.htm<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这样，对于所有的 <code>.htm</code> 请求，只要响应消息中包含了 <code>&lt;/head&gt;</code> 节点，都会自动添加 <code>HtmlContentProviderImpl.getContent(request)</code> 中返回的内容，即一段 CNZZ 脚本。</p>
<h2 id="性能和不足之处"><a href="#性能和不足之处" class="headerlink" title="性能和不足之处"></a>性能和不足之处</h2><p>在使用此过滤器和不使用此过滤器的情况下，对常规的页面（1M 以内）做了压力测试，发现吞吐量相差不大，基本可以忽略添加过滤器的影响。对于数据量比较大的页面，比如超过 1M 的页面，那么可能比较服务器消耗内存，同时在查找节点时速度也会慢一些，从而对页面性能造成一些影响。从另外一方面来说，出于性能的考虑，也应该尽可能保持页面小一些，超过 100K 的页面都值得考虑是否只能这么大。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2012/09/18/使用-Servlet-Filter-实现页面缓存/" class="prev">PREV</a><a href="/2012/05/04/从日志文件中抓取-SQL-语句的脚本/" class="next">NEXT</a></div><div data-thread-key="2012/08/08/使用-Servlet-Filter-动态添加-html-代码/" data-title="使用 Servlet Filter 动态添加 html 代码" data-url="https://akuma.github.io/2012/08/08/使用-Servlet-Filter-动态添加-html-代码/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"iakuma"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2009 - 2017 <a href="https://akuma.github.io">Akuma Huang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>